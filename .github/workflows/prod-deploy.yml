name: Deploy to Production Server

on:
  push:
    branches:
      - master

jobs:
  set:
    environment: Deploy-Prod
    runs-on: ubuntu-latest
    outputs:
      TIMESTAMP: ${{ steps.set_timestamp.outputs.TIMESTAMP }}

    steps:
      - name: ðŸ•’ Set Timestamp
        id: set_timestamp
        run: echo "TIMESTAMP=$(date +'%Y%m%d%H%M%S')" >> $GITHUB_OUTPUT

  build:
    environment: Deploy-Prod
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“‚ Checkout Repository
        uses: actions/checkout@v3
      - name: ðŸ—ï¸ Setup JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'
      - name: ðŸŽ–ï¸ Grant Execute Permission
        run: chmod +x gradlew
      - name: âš™ï¸ Create application-prod.yml
        run: |
          touch ./src/main/resources/application-prod.yml
          echo "${{ secrets.APPLICATION_PROD_YML }}" > ./src/main/resources/application-prod.yml
        shell: bash
      - name: ðŸ”¨ Build Gradle
        run: ./gradlew build --no-daemon
      - name: ðŸª‚ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          path: build/libs/onTODO-server-0.0.1-SNAPSHOT.jar
          retention-days: 1

  push:
    needs:
      - build
      - set
    runs-on: ubuntu-latest
    environment: Deploy-Prod

    steps:
      - name: ðŸ“¥ Load Outputs
        run: echo "TIMESTAMP=${{ needs.set.outputs.TIMESTAMP }}" >> $GITHUB_ENV
      - name: ðŸ·ï¸ Set Docker Image Name
        run: echo "IMAGE_NAME=${{ secrets.DOCKER_USERNAME }}/ontodo-server" >> $GITHUB_ENV
      - name: ðŸ“‚ Checkout Repository
        uses: actions/checkout@v3
      - name: ðŸ“¦ Download Artifact
        uses: actions/download-artifact@v4
        with:
          path: build/libs
      - name: ðŸ‹ Docker Login
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
      - name: ðŸ“¦ Build Docker Image
        run: docker build -t ${IMAGE_NAME}:latest -t ${IMAGE_NAME}:${TIMESTAMP} .
      - name: ðŸš€ Push Docker Image
        run: |
          docker push ${IMAGE_NAME}:latest
          docker push ${IMAGE_NAME}:${TIMESTAMP}

  deploy:
    needs: push
    runs-on: ubuntu-latest
    environment: Deploy-Prod

    steps:
      - name: ðŸ·ï¸ Set Docker Image Name
        run: echo "IMAGE_NAME=${{ secrets.DOCKER_USERNAME }}/ontodo-server" >> $GITHUB_ENV
      - name: ðŸŽ Set Docker Container Name
        run: echo "CONTAINER_NAME=onTODO-server" >> $GITHUB_ENV
      - name: ðŸ”‘ Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-agent bash -c "ssh-add ~/.ssh/id_rsa"
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
      - name: ðŸš€ Deploy to Production
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << EOF
            set -e
            echo "ðŸ›‘ Stop and Remove Existing Container"
            docker stop $CONTAINER_NAME || true
            docker rm $CONTAINER_NAME || true
          
            echo "ðŸ“¥ Pull Latest Image"
            docker pull ${IMAGE_NAME}:latest
          
            echo "ðŸš€ Run New Container"
            docker run -d --name $CONTAINER_NAME -p 8080:12222 ${IMAGE_NAME}:latest
            echo "ðŸ§¹ Cleaning up old images"
            docker system prune -af
            exit 0
          EOF